# 03a-METAL: The Virtual Substrate

*   **File:** `docs/research/03a-METAL.md`
*   **Repository:** [https://github.com/cdqn5249/cdqn](https://github.com/cdqn5249/cdqn)
*   **Author:** Christophe Duy Quang Nguyen (System Ronin)
*   **Context:** Layer 1 Specification (Continuum Memory, Hardware Abstraction, & Signal Processing)
*   **Date:** December 11, 2025
*   **Status:** `v3.8` (The Tiered Sovereignty Standard)

> **The Physics of the Machine.**
> *From the high-level architecture of the Sovereign Loom (Paper 03), we descend to the metal. This paper defines the LVM not merely as software, but as a rigid **Virtual Instruction Set Architecture (vISA)**. It guarantees that the laws of Digital Physics are enforced consistently, implementing a **Continuum Memory System** and a **Lattice Ratchet**. Crucially, it defines the **Two Tiers of Sovereignty**, distinguishing between software privacy on guest OSs and true hardware sovereignty on bare metal.*

---

## 1. Abstract: The Nested Learning Module

The Loom Virtual Machine (LVM) is designed to be the **"JVM of the Post-AI Era."** Current operating systems treat "Memory" (RAM) and "Storage" (Disk) as separate physical domains. Following the **Nested Learning** paradigm, the LVM rejects this dichotomy.

We define the machine as a **Continuum Memory System (CMS)**. The **SovereignVector** (10,240 bits) is the atomic unit. The LVM abstracts the underlying silicon to enforce **"Compute Once, Trust Anywhere"** physics, securing the timeline via the **Ouroboros Ratchet** which consumes keys to generate time.

---

## 2. The Physical Atom: `SovereignVector`

The LVM ignores the host's native word size (32/64-bit). It enforces a uniform geometric standard derived from a sovereign source.

### 2.1 The Genesis Origin (The Ouroboros)
*   **The Seed:** Every vector space is initialized by a **`GenesisSeed`** (Paper 02a).
*   **The Ratchet:** The seed is not static. It is a **Consumable Fuel**.
    *   Every logical tick, the LVM mutates the seed using a One-Way Function (OWF).
    *   **Physical Erasure:** Immediately after mutation, the LVM performs a **Secure Zero Overwrite** on the memory address of the old seed. This guarantees that even a raw RAM dump cannot recover past keys.
*   **The Stream:** Vectors are slices of the deterministic stream generated by the *current* state of the seed.

### 2.2 The Virtual Specification
*   **Physical Alignment:** 10,240 bits ($160 \times 64$-bit words).
*   **Rationale:** LCM of 64, 128, 256, 512-bit vector lanes.

---

## 3. The Continuum Memory System (CMS)

We replace the "RAM vs Disk" model with a **Frequency-Based Hierarchy**.

### Level 1: The Fovea (High Frequency $\omega_{high}$)
*   **Physics:** **Liquid Phase**.
*   **Hardware:** L1/L2 Cache & NPU.
*   **Function:** **In-Context Learning.** Immediate reasoning.

### Level 2: The Context (Mid Frequency $\omega_{mid}$)
*   **Physics:** **Gas Phase**.
*   **Hardware:** System RAM (Encrypted).
*   **Blind Indexing:** Uses unencrypted **Perceptual Hashes** for search, while data remains encrypted blobs.

### Level 3: The Deep Lattice (Low Frequency $\omega_{low}$)
*   **Physics:** **Crystal Phase**.
*   **Hardware:** NVMe SSD / Disk-Resident Graph.
*   **Function:** **Long-Term Knowledge.**
    *   **Thermal Storage:** We store the **Temperature ($T$)** (Stability) and **Mass ($m$)** (Weight) of every vector alongside the bits.
    *   **Scalability:** Uses Disk-Resident Indexing (e.g., DiskANN).
    *   **Entropy Interleaving:** Retrieving from disk takes time (~50Âµs). The LVM spawns a high-priority **Entropy Worker Thread** that utilizes this I/O wait-time to generate ChaCha20 noise.

---

## 4. The Quad-State Physics (The Instruction Set)

The LVM vISA defines four classes of operations, modeled as states of matter within the CMS.

| State | Matter | Physics | LVM Opcode | Function |
| :--- | :--- | :--- | :--- | :--- |
| **1** | **Crystal** | **Solid** | `LVM_ACC` | **Consolidate.** (Accumulate Mass). |
| **2** | **Liquid** | **Fluid** | `LVM_BIND` | **React.** (XOR / Binding). |
| **3** | **Gas** | **Diffusion** | `LVM_MOV` | **Contextualize.** (Shift). |
| **4** | **Plasma** | **Energy** | `LVM_MASK` | **Isolate.** (Error/collision handling). |

### 4.1 The Plasma Reflex (Masking)
Plasma acts as the system's "Immune Response."
*   **Event:** A Matroid Exclusion failure (Collision) or Logic Violation.
*   **Reflex:** The LVM generates a **Plasma Mask** (Bitmask `0` at Index $N$).
*   **Result:** The corrupted bit is electrically insulated. Logic flows around the damage.

---

## 5. The Runtime Topology: Tiered Sovereignty

Following the security axioms defined in **`02e-RITUALS`**, the LVM implementation is strictly divided into two tiers based on the hardware trust model.

### Tier 1: Library Mode (Guest Sovereignty)
*   **Target:** Android (APK), Windows, Linux (User Space).
*   **Implementation:** `libcdqn` (Rust).
*   **Security Context:** **Privacy.**
    *   **Constraint:** The Host OS controls memory and I/O. The LVM cannot enforce "Physical Erasure" or "Antimatter" protocols against a Root attacker.
    *   **Rituals:** Emulated via software. Useful for preventing accidents, but not secure against "God Mode" attacks.
    *   **Entropy:** Derived from Host OS CSPRNG.

### Tier 2: Sovereign Mode (Hardware Sovereignty)
*   **Target:** Raspberry Pi, RISC-V Boards, Robotics (Bare Metal).
*   **Implementation:** `cdqnOS` (Unikernel / Type-1 Hypervisor) + **TEE**.
*   **Security Context:** **Sovereignty.**
    *   **Constraint:** The LVM controls the silicon. The `GenesisSeed` is anchored in the **Trusted Execution Environment (TEE)**.
    *   **Rituals:** Enforced via Hardware Interrupts (The Totem).
    *   **Antimatter:** Active. The system can physically destroy keys if a VDF violation is detected.

---

## 6. The Tri-Guard Security Protocol

We implement "Defense in Depth" within the Hardware Abstraction Layer (HAL).

| Guard Layer | Mechanism | The Check | Behavior |
| :--- | :--- | :--- | :--- |
| **1. Spatial** | **Virtual Arena** | *"Is this stack safe?"* | **Stack Safety.** Pre-allocated Arena prevents recursion overflows. |
| **2. Temporal** | **The Ouroboros** | *"Is this key fresh?"* | **Forward Secrecy.** See Constraint 6.2 below. |
| **3. Spectral** | **LWE Noise** | *"Is this memory visible?"* | **Obfuscation.** Adaptive Thermodynamics. |

### 6.1 Adaptive Thermodynamics (The Dark Mode)
To balance Security with Usability (Battery Life), the LVM implements **Adaptive Obfuscation**.
*   **Green Mode (Default on Battery):** Unused RAM is zeroed. High efficiency.
*   **Dark Mode (Default on Plugged/Panic):** Unused RAM is filled with **ChaCha20** noise.

### 6.2 The Ouroboros Constraint
*   **In Tier 2 (Sovereign):** Old keys are overwritten with `0x00` and the memory cell is flushed via direct hardware instruction.
*   **In Tier 1 (Guest):** Old keys are overwritten via `volatile_memset`, but the OS Paging system may have created swap copies. **Forward Secrecy is "Best Effort."**

---

## 7. The Execution Engine (The Bridge)

The LVM acts as a bridge between the **Chemical Logic** of the user and the **Binary Logic** of the chip.

*   **The Scheduler:** Translates `cdqnLang` interactions ($A \multimap B$) into Vector Operations.
*   **The Hysteresis Loop:** To prevent bus saturation on consumer devices, the engine batches operations.
    *   *Small Batch (< 1k vectors):* Processed on CPU (L1 Cache) for low latency.
    *   *Large Batch (> 1k vectors):* Offloaded to NPU/GPU (Vulkan/Compute) for high throughput.
*   **Result:** The same binary scales seamlessly from a smartphone (using the NPU for efficiency) to a workstation (using the GPU for massive simulation).

---

### ðŸ“‚ Bibliography & References
1.  **Behrouz, A. et al.** (2025). *"Nested Learning: The Illusion of Deep Learning Architecture."* Google Research.
2.  **MartÃ­n-Olalla, J.M.** (2025). *"Thermal stability originates the vanishing of the specific heats."* Physica Scripta.
3.  **Jayaram, S. et al.** (2019). *"DiskANN: Fast Accurate Billion-Point Nearest Neighbor Search on a Single Node."*
4.  **Peikert, C.** (2016). *"A Decade of Lattice Cryptography."* (Forward Secrecy foundations).

---

**License:** Universal Sovereign Source License (USSL) v2.0.
